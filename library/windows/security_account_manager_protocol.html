

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Security Account Manager Remote Protocol (SAMRP) &#8212; Threat Hunter Playbook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="../../_static/tabs.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'library/windows/security_account_manager_protocol';</script>
    <link rel="canonical" href="https://threathunterplaybook.com/library/windows/security_account_manager_protocol.html" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Security Assertion Markup Language (SAML)" href="security_assertion_markup_language.html" />
    <link rel="prev" title="Security Account Manager (SAM) Database" href="security_account_manager_database.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Threat Hunter Playbook - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Threat Hunter Playbook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Knowledge Library</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="intro.html">Windows</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="active_directory_replication.html">Active Directory Replication</a></li>
<li class="toctree-l2"><a class="reference internal" href="adfs_dkm_keys.html">Active Directory Federation Services (ADFS) Distributed Key Manager (DKM) Keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_protection_api.html">Data Protection API</a></li>
<li class="toctree-l2"><a class="reference internal" href="logon_session.html">Logon Session</a></li>
<li class="toctree-l2"><a class="reference internal" href="lsa_policy_objects.html">LSA Policy Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="mimikatz_openprocess_modules.html">Mimikatz OpenProcess Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="process_access_rights.html">Process Security and Access Rights</a></li>
<li class="toctree-l2"><a class="reference internal" href="security_account_manager_database.html">Security Account Manager (SAM) Database</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Security Account Manager Remote Protocol (SAMRP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="security_assertion_markup_language.html">Security Assertion Markup Language (SAML)</a></li>
<li class="toctree-l2"><a class="reference internal" href="service_control_manager.html">Service Control Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="syskey.html">SysKey</a></li>
<li class="toctree-l2"><a class="reference internal" href="task_scheduler_service.html">Task Scheduler Service</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Pre-Hunt Activities</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../pre-hunt/data_management.html">Data Management</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../pre-hunt/data_documentation.html">Data Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre-hunt/data_standardization.html">Data Standardization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre-hunt/data_modeling.html">Data Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre-hunt/data_quality.html">Data Quality</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Guided Hunts</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../hunts/windows/intro.html">Windows</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/170105-LSASSMemoryReadAccess/notebook.html">LSASS Memory Read Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/180719-DLLProcessInjectionCreateRemoteThread/notebook.html">DLL Process Injection via CreateRemoteThread and LoadLibrary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/180815-ADObjectAccessReplication/notebook.html">Active Directory Object Access via Replication Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190101-ADModDirectoryReplication/notebook.html">Active Directory Root Domain Modification for Replication Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190407-RegModEnableRDPConnections/notebook.html">Registry Modification to Enable Remote Desktop Conections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190410-LocalPwshExecution/notebook.html">Local PowerShell Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190510-RegModWDigestDowngrade/notebook.html">WDigest Downgrade</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190511-RemotePwshExecution/notebook.html">PowerShell Remote Session</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190610-PwshAlternateHosts/notebook.html">Alternate PowerShell Hosts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190620-DomainDPAPIBackupKeyExtraction/notebook.html">Domain DPAPI Backup Key Extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190625-RegKeyAccessSyskey/notebook.html">SysKey Registry Keys Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190725-SAMRegistryHiveHandleRequest/notebook.html">SAM Registry Hive Handle Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190810-RemoteWMIExecution/notebook.html">WMI Win32_Process Class and Create Method for Remote Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190810-WMIEventing/notebook.html">WMI Eventing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190811-WMIModuleLoad/notebook.html">WMI Module Load</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190813-LocalServiceInstallation/notebook.html">Local Service Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190815-RemoteServiceInstallation/notebook.html">Remote Service creation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/190826-RemoteSCMHandle/notebook.html">Remote Service Control Manager Handle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/191030-RemoteInteractiveTaskMgrLsassDump/notebook.html">Remote Interactive Task Manager LSASS Dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/191224-RegModExtendedNetNTLMDowngrade/notebook.html">Registry Modification for Extended NetNTLM Downgrade</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/200609-MicrophoneDvcAccess/notebook.html">Access to Microphone Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/200902-RemoteWMIActiveScriptEventConsumers/notebook.html">Remote WMI ActiveScriptEventConsumers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/201009-RemoteDCOMIErtUtilDLLHijack/notebook.html">Remote DCOM IErtUtil DLL Hijack</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/201009-RemoteWMIWbemcomnDLLHijack/notebook.html">Remote WMI Wbemcomn DLL Hijack</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/201012-RemoteCreateFileSMB/notebook.html">SMB Create Remote File</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hunts/windows/201012-WuaucltCreateRemoteThread/notebook.html">Wuauclt CreateRemoteThread Execution</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials/jupyter/introduction.html">Jupyter Notebooks</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/jupyter/installing_jupyter.html">Jupyter Server Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/jupyter/notebooks/01_intro_to_python.html">Introduction to Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/jupyter/notebooks/02_intro_to_numpy_arrays.html">Introduction to Python NumPy Arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/jupyter/notebooks/03_intro_to_pandas.html">Introduction to Pandas</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/OTRF/ThreatHunter-Playbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/OTRF/ThreatHunter-Playbook/edit/master/docs/library/windows/security_account_manager_protocol.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/OTRF/ThreatHunter-Playbook/issues/new?title=Issue%20on%20page%20%2Flibrary/windows/security_account_manager_protocol.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/library/windows/security_account_manager_protocol.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Security Account Manager Remote Protocol (SAMRP)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#security-account-manager-remote-protocol-samrp-client-to-server">Security Account Manager Remote Protocol (SAMRP) Client-To-Server ©</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#object-based-perspective">Object-based perspective</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#method-based-perspective">Method Based Perspective</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transport">Transport</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#protocol-details">Protocol Details</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#server">Server</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#client">Client</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abusing-remote-calls-to-sam">Abusing Remote Calls to SAM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="security-account-manager-remote-protocol-samrp">
<h1>Security Account Manager Remote Protocol (SAMRP)<a class="headerlink" href="#security-account-manager-remote-protocol-samrp" title="Permalink to this heading">#</a></h1>
<p>Accounts are always created relative to an issuing authority. In Windows, the issuing authority is referred to as a domain. A domain can be either a local domain or extend across a network. Domains store information about their accounts in an account database. Windows uses Active Directory as the account database in domain-based environments, whereas in environments that are not domain-based, it uses the security account manager (SAM) built-in database as the account database.</p>
<section id="security-account-manager-remote-protocol-samrp-client-to-server">
<h2>Security Account Manager Remote Protocol (SAMRP) Client-To-Server ©<a class="headerlink" href="#security-account-manager-remote-protocol-samrp-client-to-server" title="Permalink to this heading">#</a></h2>
<p>The Security Account Manager (SAM) Remote Protocol (Client-to-Server) depends on the RPC protocol (uses RPC as a transport), and provides management functionality for an account store or directory containing users and groups. The goal of this protocol is to enable IT administrators and end users to manage users, groups, and computers. This protocol achieves its goal by enabling the creation, reading, updating, and deleting of security principal information. These security principals could be in any account store. Windows implements this protocol, for example, in a directory service (Active Directory) and in a computer-local security account database known as the Security Account Manager (SAM) database.</p>
<p>This protocol follows two perspectives when understanding and implementing this protocol:</p>
</section>
<section id="object-based-perspective">
<h2>Object-based perspective<a class="headerlink" href="#object-based-perspective" title="Permalink to this heading">#</a></h2>
<p>The object-based perspective shows that the protocol exposes five main object abstractions: a server object, a domain object, a group object, an alias object (an “alias” being a type of group), and a user object. A client obtains a “handle” (an RPC context handle) to one of these objects and then performs one or more actions on the object.</p>
<p>You can find the list of methods that operate on each of the respective object types in <a class="reference external" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/8aaff2f7-1edd-41a0-ab58-4807ac6124c5">here</a></p>
</section>
<section id="method-based-perspective">
<h2>Method Based Perspective<a class="headerlink" href="#method-based-perspective" title="Permalink to this heading">#</a></h2>
<p>The method-based perspective is used to show a common set of operations for each object type. The operations fall into patterns. A list of the patterns and associated methods, along with a description of each pattern, is available <a class="reference external" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/d7b62596-4a46-4556-92dc-3aba6d517907">here</a>. A brief description is available below:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Pattern</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Open</p></td>
<td><p>This pattern returns an RPC context handle that references a specific object type. A client uses this pattern by specifying a specific access for the handle in the request, and using the returned handle to call other methods that require the returned handle along with the associated access.</p></td>
</tr>
<tr class="row-odd"><td><p>Enumerate</p></td>
<td><p>This pattern allows a client to obtain a complete list of all objects of a certain type (domain, group, alias, or user).</p></td>
</tr>
<tr class="row-even"><td><p>Selective Enumerate</p></td>
<td><p>This pattern allows a client to obtain a partial list of objects based on the name of the objects. These methods, for example, allow a client to obtain a bounded number of objects from a virtual list of objects sorted alphabetically by name starting with a client-specified prefix, such as “Chr”.</p></td>
</tr>
<tr class="row-odd"><td><p>Create</p></td>
<td><p>This pattern allows specified objects to be created. A handle to the newly created object is returned.</p></td>
</tr>
<tr class="row-even"><td><p>Query</p></td>
<td><p>This pattern allows specified attributes of an object to be returned. The client specifies which attributes to return by using an “information level”. The information level is an enumeration that the server understands and translates into a specific structure to return; the structure contains the attributes indicated by the information level.</p></td>
</tr>
<tr class="row-odd"><td><p>Set</p></td>
<td><p>This pattern allows specified object attributes to be set. The client indicates the attributes that are to be updated by specifying an “information level”. Similar to the query pattern of methods, the information level specifies the attributes that are being sent in the request.</p></td>
</tr>
<tr class="row-even"><td><p>Delete</p></td>
<td><p>This pattern allows a client to delete a specified object.</p></td>
</tr>
<tr class="row-odd"><td><p>Membership</p></td>
<td><p>This pattern allows a client to add to, remove from, or query the membership list for either a group or an alias object.</p></td>
</tr>
<tr class="row-even"><td><p>Membership-Of</p></td>
<td><p>This pattern allows a client to obtain the groups or aliases that a user or collection of security identifiers (SIDs) is a member of.</p></td>
</tr>
<tr class="row-odd"><td><p>Change Password</p></td>
<td><p>This pattern allows a client to change a password on a user object. The client provides the current password and new password, and the server verifies that the client-presented current password matches the server-persisted current password for the user. If there is a match, the new password is persisted.</p></td>
</tr>
<tr class="row-even"><td><p>Lookup</p></td>
<td><p>This pattern allows a client to translate between a relative identifier (RID) or SID, and a user-friendly display name (the name of the object).</p></td>
</tr>
<tr class="row-odd"><td><p>Security</p></td>
<td><p>This pattern allows a client to specify or query access control with a granularity of individual objects.</p></td>
</tr>
<tr class="row-even"><td><p>Miscellaneous</p></td>
<td><p>The following methods do not fall into a general pattern.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="transport">
<h2>Transport<a class="headerlink" href="#transport" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>This protocol uses UUID 12345778-1234-ABCD-EF00-0123456789AC to identify the RPC interface</p></li>
<li><p>This protocol uses the following RPC protocol sequences:</p>
<ul>
<li><p>RPC over SMB ( This protocol uses the pipe name “\PIPE\samr” for the endpoint name )</p></li>
<li><p>RPC over TCP ( This protocol uses RPC dynamic endpoints )</p></li>
</ul>
</li>
</ul>
</section>
<section id="protocol-details">
<h2>Protocol Details<a class="headerlink" href="#protocol-details" title="Permalink to this heading">#</a></h2>
<section id="server">
<h3>Server<a class="headerlink" href="#server" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>This protocol enables create, read, update, and delete semantics over an account domain. Five abstract objects are exposed through this protocol: server, domain, group, alias, and user. User, group, and alias objects can be created and deleted; all objects can be updated and read.</p></li>
<li><p>For methods that accept a context handle, the security model is a handle-based security model. A client obtains a handle with a client-specified access for that handle. The handle can then be used for operations that require the granted access.</p></li>
</ul>
</section>
<section id="client">
<h3>Client<a class="headerlink" href="#client" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>The client MUST create a secure RPC session such that the server can identify and determine the authorization for the client.</p></li>
</ul>
</section>
</section>
<section id="abusing-remote-calls-to-sam">
<h2>Abusing Remote Calls to SAM<a class="headerlink" href="#abusing-remote-calls-to-sam" title="Permalink to this heading">#</a></h2>
<p>The SAMRPC protocol makes it possible for a low privileged user to query a machine on a network for data. For example, a user can use SAMRPC to enumerate users, including privileged accounts such as local or domain administrators, or to enumerate groups and group memberships from the local SAM and Active Directory. This information can provide important context and serve as a starting point for an attacker to compromise a domain or networking environment.</p>
<p>By default, the SAM can be accessed remotely (via SAMR) by any authenticated user, including network connected users, which effectively means that any domain user is able to access it. Windows 10 had introduced an option to control the remote access to the SAM, through a specific registry value. On Windows Anniversary update (Windows 10 Version 1607) the default permissions were changed to allow remote access only to administrators. An accompanying Group Policy setting was added, which gives a user-friendly interface to alter these default permissions.</p>
<p>There are corresponding events that indicate when remote calls to the SAM are restricted, what accounts attempted to read from the SAM database, and more <a class="reference external" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-access-restrict-clients-allowed-to-make-remote-sam-calls#related-events">here</a>.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-access-restrict-clients-allowed-to-make-remote-sam-calls#audit-only-mode">https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-access-restrict-clients-allowed-to-make-remote-sam-calls#audit-only-mode</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/8aaff2f7-1edd-41a0-ab58-4807ac6124c5">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/8aaff2f7-1edd-41a0-ab58-4807ac6124c5</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-access-restrict-clients-allowed-to-make-remote-sam-calls">https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-access-restrict-clients-allowed-to-make-remote-sam-calls</a></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "OTRF/ThreatHunter-Playbook",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./library/windows"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="security_account_manager_database.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Security Account Manager (SAM) Database</p>
      </div>
    </a>
    <a class="right-next"
       href="security_assertion_markup_language.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Security Assertion Markup Language (SAML)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#security-account-manager-remote-protocol-samrp-client-to-server">Security Account Manager Remote Protocol (SAMRP) Client-To-Server ©</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#object-based-perspective">Object-based perspective</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#method-based-perspective">Method Based Perspective</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transport">Transport</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#protocol-details">Protocol Details</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#server">Server</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#client">Client</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abusing-remote-calls-to-sam">Abusing Remote Calls to SAM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Roberto Rodriguez @Cyb3rWard0g
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>